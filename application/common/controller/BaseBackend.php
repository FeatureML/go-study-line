<?php

/** .-------------------------------------------------------------------
 * |  Github: https://github.com/Tinywan
 * |  Blog: http://www.cnblogs.com/Tinywan
 * |-------------------------------------------------------------------
 * |  Author: Tinywan(ShaoBo Wan)
 * |  DateTime: 2017/8/28 14:42
 * |  Mail: Overcome.wan@Gmail.com
 * '-------------------------------------------------------------------*/

namespace app\common\controller;

use app\common\library\Auth;
use think\Hook;
use think\Request;

class BaseBackend extends Base
{
    // 权限实例
    protected $auth;

    // 钩子获取角色
    protected $role;

    //构造方法
    public function __construct(Request $request = null)
    {
        // 添加钩子
        $result = Hook::listen('controller_init',$this,$request,true);
        if ($result) {
            // 当前角色名
            $this->role = $result;
        }
        parent::__construct($request);
    }

    protected function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        if (!session('admin.admin_id')) {
            $this->redirect("backend/login/login");
        }
        $controllerName = strtolower($this->request->controller());
        $actionName = strtolower($this->request->action());
        $checkAuth = $controllerName . '/' . $actionName;
        $this->auth = new Auth();
        $checkResult = $this->auth->check($checkAuth, session('admin.admin_id'));
        // public auth
        $openAuth = config('auth_config')['open_auth'];
        if (is_array($openAuth) AND in_array($checkAuth, $openAuth)) return true;
        if (!$checkResult) $this->error('没有权限');
    }


}